@using Thryft.Models
@using Thryft.Services
@inject CartService cartService
@inject NavigationManager Navigation
@inject UserService userService

@rendermode InteractiveServer

<MudPopoverProvider />

<MudAppBar Class="py-2" Style="z-index: 1300 !important;">
    @* <MudIconButton Color="Color.Tertiary" Icon="@Icons.Material.Filled.Menu" Href="">Filter</MudIconButton> *@
    <MudSpacer />
    <MudText @onclick="NavigateToHome">thryft</MudText>
    <MudSpacer/>
    <MudText Class="pe-1">Welcome @user.Name</MudText>
    <MudBadge Color="Color.Dark" Content="@cartService.CurrentCart.TotalItems" Max="99">
        <MudIconButton Icon="@Icons.Material.Filled.ShoppingCart"
                       Href="/cart"
                       Color="Color.Tertiary" />
    </MudBadge>
    <MudMenu Color="Color.Tertiary" Class="ms-4" Icon="@Icons.Material.Filled.Person" Style="z-index: 15000">
        <MudMenuItem Onclick="NavigateToProfile">Profile</MudMenuItem>
        <MudMenuItem Onclick="NavigateToOrders">Orders</MudMenuItem>
        <MudDivider/>
        <MudMenuItem Href="/">Logout</MudMenuItem>
    </MudMenu>
</MudAppBar>

@code {
    // private User user = userService.currentUser;

    private User user = new User
    {
        UserId = 4,
        Name = "TEST USER",
        Email = "test@test.com",
        Password = "Test"
    };

    protected override void OnInitialized()
    {
        // Subscribe to cart updates so the badge updates in real-time
        cartService.OnCartUpdated += StateHasChanged;


    }

    private void NavigateToHome()
    {
        Navigation.NavigateTo("/home");
    }

    private void NavigateToCart()
    {
        Navigation.NavigateTo("/cart");
    }

    private void NavigateToProfile()
    {
        Navigation.NavigateTo("/profile");
    }

    private void NavigateToOrders()
    {
        Navigation.NavigateTo("/orders");
    }

    public void Dispose()
    {
        // Important: Unsubscribe to prevent memory leaks
        cartService.OnCartUpdated -= StateHasChanged;
    }
}